rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // DUAL ACCESS: Public read for frontend + Full access for authenticated CRM users
    
    match /startups/{startup} {
      allow read: if true; // Public read for frontend display
      allow write: if request.auth != null; // CRM write access
      allow create: if true; // Allow startup applications
    }
    
    match /team/{member} {
      allow read: if true; // Public read for frontend display
      allow write: if request.auth != null; // CRM write access
      allow create: if request.auth != null;
    }
    
    match /events/{event} {
      allow read: if true; // Public read for frontend display
      allow write: if request.auth != null; // CRM write access
      allow create: if request.auth != null;
    }
    
    match /blog/{post} {
      allow read: if true; // Public read for frontend display
      allow write: if request.auth != null; // CRM write access
      allow create: if request.auth != null;
    }
    
    match /partners/{partner} {
      allow read: if true; // Public read for frontend display
      allow write: if request.auth != null; // CRM write access
      allow create: if request.auth != null;
    }
    
    match /mentors/{mentor} {
      allow read: if true; // Public read for frontend display
      allow write: if request.auth != null; // CRM write access
      allow create: if request.auth != null;
    }
    
    // Mixed access for investors
    match /investors/{investor} {
      allow read: if request.auth != null; // Private - only CRM can read
      allow write: if request.auth != null; // CRM write access
      allow create: if true; // Allow investor registration from frontend
    }
    
    match /applications/{application} {
      allow read: if request.auth != null; // CRM can read applications
      allow create: if true; // Allow public applications from frontend
      allow update: if request.auth != null; // CRM can update
      allow delete: if request.auth != null; // CRM can delete
    }
    
    // Gallery/Photos collection for frontend
    match /gallery/{photo} {
      allow read: if true; // Public read for frontend gallery
      allow write: if request.auth != null; // CRM write access
      allow create: if request.auth != null;
    }
    
    match /photos/{photo} {
      allow read: if true; // Public read for frontend gallery
      allow write: if request.auth != null; // CRM write access
      allow create: if request.auth != null;
    }
    
    // Public collections
    match /newsletter/{subscription} {
      allow read: if false; // No public read access to email list
      allow create: if true; // Allow public subscription
      allow update, delete: if request.auth != null;
    }
    
    match /event_registrations/{registration} {
      allow read: if request.auth != null; // CRM can read registrations
      allow create: if true; // Allow public event registration
      allow update: if request.auth != null;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
  }
}